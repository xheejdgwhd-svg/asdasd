<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AI Calorie Tracker</title>
  <style>
    :root{--bg:#0f1724;--card:#0b1220;--muted:#9aa4b2;--accent:#7c3aed;--glass:rgba(255,255,255,0.03)}
    html,body{height:100%;margin:0;font-family:Inter,ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial}
    body{background:linear-gradient(180deg,#071023 0%, #071427 60%);display:flex;align-items:center;justify-content:center;padding:28px;color:#e6eef8}
    .app{width:960px;max-width:96vw;background:linear-gradient(180deg,rgba(255,255,255,0.02),transparent);border-radius:16px;padding:22px;box-shadow:0 10px 30px rgba(2,6,23,0.6);}
    .head{display:flex;gap:16px;align-items:center}
    .logo{width:56px;height:56px;border-radius:12px;background:linear-gradient(135deg,var(--accent),#2dd4bf);display:flex;align-items:center;justify-content:center;font-weight:700;color:white}
    h1{margin:0;font-size:20px}
    p.lead{margin:0;color:var(--muted);font-size:13px}

    .grid{display:grid;grid-template-columns:420px 1fr;gap:18px;margin-top:18px}
    .card{background:var(--card);padding:14px;border-radius:12px;border:1px solid rgba(255,255,255,0.03)}

    .upload{display:flex;flex-direction:column;gap:12px}
    .drop{height:220px;border-radius:10px;border:2px dashed rgba(255,255,255,0.04);display:flex;align-items:center;justify-content:center;flex-direction:column;gap:10px;background:var(--glass);cursor:pointer;transition:transform .15s}
    .drop.hover{transform:translateY(-4px);box-shadow:0 10px 30px rgba(2,6,23,0.6)}
    .drop img{max-width:100%;max-height:100%;border-radius:8px;object-fit:cover}
    .controls{display:flex;gap:8px;align-items:center}
    button.btn{background:linear-gradient(90deg,var(--accent),#06b6d4);border:none;padding:10px 12px;border-radius:10px;color:white;font-weight:600;cursor:pointer}
    button.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);padding:10px 12px;border-radius:10px;color:var(--muted);cursor:pointer}

    .results{display:flex;flex-direction:column;gap:10px}
    .statrow{display:flex;gap:12px;align-items:center}
    .stat{flex:1;background:linear-gradient(180deg,rgba(255,255,255,0.02),transparent);padding:12px;border-radius:10px}
    .label{font-size:12px;color:var(--muted)}
    .value{font-weight:700;font-size:18px}

    .chartwrap{display:flex;align-items:center;gap:14px}
    canvas{background:transparent}

    .footer{margin-top:12px;color:var(--muted);font-size:12px}
    .small{font-size:12px;color:var(--muted)}

    .loader{height:8px;background:linear-gradient(90deg, rgba(255,255,255,0.04), rgba(255,255,255,0.08));border-radius:999px;overflow:hidden}
    .loader > i{display:block;height:100%;width:20%;background:linear-gradient(90deg,var(--accent),#06b6d4);transform:translateX(-100%);animation:loading 1.2s linear infinite}
    @keyframes loading{to{transform:translateX(400%)}}

    @media(max-width:920px){.grid{grid-template-columns:1fr} .card{padding:12px}}
  </style>
</head>
<body>
  <main class="app" role="main">
    <div class="head">
      <div class="logo">AC</div>
      <div>
        <h1>AI Calorie Tracker</h1>
        <p class="lead">Upload a photo of your meal — get an instant estimate of calories and P / F / C breakdown (uses GPT API).</p>
      </div>
    </div>

    <div class="grid">
      <section class="card upload">
        <div id="drop" class="drop" tabindex="0">
          <div id="dropContents">
            <strong>Drag & drop a meal photo</strong>
            <div class="small">or click to choose an image (jpg, png). Keep file &lt; 5MB for best speed.</div>
          </div>
          <img id="preview" alt="preview" style="display:none"/>
        </div>

        <div class="controls">
          <input id="file" type="file" accept="image/*" style="display:none">
          <button id="pick" class="ghost">Choose photo</button>
          <button id="analyze" class="btn" disabled>Analyze with GPT</button>
          <div style="flex:1"></div>
        </div>

        <div id="progress" style="display:none;margin-top:8px">
          <div class="loader"><i></i></div>
          <div class="small" id="progressText">Sending to GPT... (this transmits only the image to the OpenAI endpoint)</div>
        </div>

        <div class="footer">Note: Replace <code>OPENAI_API_KEY</code> inside the file with your key. This single-file demo sends the image to OpenAI — keep your key private.</div>
      </section>

      <aside class="card results">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <div class="small">Estimated calories</div>
            <div class="value" id="calories">—</div>
          </div>
          <div>
            <div class="small">Confidence</div>
            <div class="value" id="confidence">—</div>
          </div>
        </div>

        <div class="statrow">
          <div class="stat">
            <div class="label">Protein (g)</div>
            <div class="value" id="protein">—</div>
          </div>
          <div class="stat">
            <div class="label">Fat (g)</div>
            <div class="value" id="fat">—</div>
          </div>
          <div class="stat">
            <div class="label">Carbs (g)</div>
            <div class="value" id="carbs">—</div>
          </div>
        </div>

        <div class="chartwrap">
          <canvas id="pie" width="300" height="200" aria-label="PFC pie chart"></canvas>
          <div style="min-width:120px">
            <div class="small">Calorie breakdown</div>
            <div class="small" id="macroCalories">—</div>
            <div style="height:8px"></div>
            <div class="small">Interpretation</div>
            <div class="small" id="interpret">—</div>
          </div>
        </div>

        <div style="margin-top:8px" class="small">Last response raw: <pre id="raw" style="white-space:pre-wrap;max-height:140px;overflow:auto"></pre></div>
      </aside>
    </div>
  </main>

  <script>
    // ----------------------------
    // CONFIG: Insert your key here
    // ----------------------------
    const OPENAI_API_KEY = 'REPLACE_WITH_YOUR_OPENAI_API_KEY';
    const OPENAI_CHAT_COMPLETIONS = 'https://api.openai.com/v1/chat/completions';
    // model choice: change if needed
    const MODEL = 'gpt-5o-mini';

    // ui
    const drop = document.getElementById('drop');
    const fileInput = document.getElementById('file');
    const pickBtn = document.getElementById('pick');
    const analyzeBtn = document.getElementById('analyze');
    const preview = document.getElementById('preview');
    const progress = document.getElementById('progress');
    const progressText = document.getElementById('progressText');

    let lastDataUrl = null;

    function setBusy(b){
      progress.style.display = b ? 'block' : 'none';
      analyzeBtn.disabled = b || !lastDataUrl;
    }

    function resetResults(){
      document.getElementById('calories').textContent='—';
      document.getElementById('confidence').textContent='—';
      document.getElementById('protein').textContent='—';
      document.getElementById('fat').textContent='—';
      document.getElementById('carbs').textContent='—';
      document.getElementById('macroCalories').textContent='—';
      document.getElementById('interpret').textContent='—';
      document.getElementById('raw').textContent='—';
      drawPie([0,0,0]);
    }

    // drag/drop
    ;['dragenter','dragover'].forEach(e=>drop.addEventListener(e,ev=>{ev.preventDefault();drop.classList.add('hover')}));
    ;['dragleave','drop'].forEach(e=>drop.addEventListener(e,ev=>{ev.preventDefault();drop.classList.remove('hover')}));

    drop.addEventListener('drop',async ev=>{
      const f = ev.dataTransfer.files[0];
      if(f) await handleFile(f);
    });

    drop.addEventListener('click',()=>fileInput.click());
    pickBtn.addEventListener('click',()=>fileInput.click());
    fileInput.addEventListener('change',async e=>{const f=e.target.files[0]; if(f) await handleFile(f);});

    async function handleFile(file){
      resetResults();
      if(!file.type.startsWith('image/')){alert('Please supply an image file.');return}
      if(file.size > 8 * 1024 * 1024){ if(!confirm('File is large (>8MB). Continue?')) return }
      const reader = new FileReader();
      reader.onload = ()=>{
        lastDataUrl = reader.result;
        preview.src = lastDataUrl;
        preview.style.display = 'block';
        analyzeBtn.disabled = false;
      };
      reader.readAsDataURL(file);
    }

    analyzeBtn.addEventListener('click',async ()=>{
      if(!lastDataUrl){alert('Choose a photo first.');return}
      setBusy(true);
      progressText.textContent = 'Sending image to GPT for nutrition estimation...';
      try{
        const payload = buildPromptFromDataUrl(lastDataUrl);
        const resp = await callOpenAI(payload);
        // parse JSON from model reply
        const text = resp;
        document.getElementById('raw').textContent = text;
        const json = extractJSON(text);
        if(!json){ throw new Error('Could not parse JSON from model response') }
        showResults(json);
      }catch(err){
        console.error(err);
        alert('Error: '+err.message);
      }finally{setBusy(false)}
    });

    function buildPromptFromDataUrl(dataURL){
      // We send a short system + user instruction. We include the image as a base64 data URL string and ask for strict JSON.
      const system = `You are a helpful nutrition estimation assistant. The user will provide a single image (base64 data URL) of a prepared dish. Use visual cues to estimate total calories and grams of protein, fat, and carbohydrates in the pictured serving. Provide also a confidence score between 0 and 1. Return only a single valid JSON object — do not include any explanatory text. Keys required: calories (number, kcal), protein_g (number), fat_g (number), carbs_g (number), confidence (0-1). Also include an optional field "notes" (string) for ambiguity reasons, and an optional field "estimated_calories_from_macros" (number) that you compute as protein*4 + carbs*4 + fat*9.`;
      const user = `IMAGE_DATA_URL:\n${dataURL}\n\nINSTRUCTIONS:\n- Make best-effort visual nutrition estimates based on the image.\n- Return only JSON (no markdown, no backticks).\n- Use numbers (no units inside the number fields).\n- Provide reasonable rounding (1 decimal for grams, 0 or 1 decimal for calories).`;
      return [{role:'system',content:system},{role:'user',content:user}];
    }

    async function callOpenAI(messages){
      if(!OPENAI_API_KEY || OPENAI_API_KEY.startsWith('REPLACE')) throw new Error('Set your OPENAI_API_KEY in the file to use the demo.');
      const body = {model: MODEL, messages: messages, temperature:0.2, max_tokens:400};
      const r = await fetch(OPENAI_CHAT_COMPLETIONS,{
        method:'POST',
        headers:{'Content-Type':'application/json','Authorization':'Bearer '+OPENAI_API_KEY},
        body:JSON.stringify(body)
      });
      if(!r.ok){
        const txt = await r.text();
        throw new Error('OpenAI error: '+r.status+' '+txt);
      }
      const data = await r.json();
      // extract content
      const content = (data.choices && data.choices[0] && data.choices[0].message && data.choices[0].message.content) || JSON.stringify(data);
      return content;
    }

    function extractJSON(text){
      // Find the first JSON object in text
      const start = text.indexOf('{');
      const end = text.lastIndexOf('}');
      if(start===-1||end===-1) return null;
      const jsonText = text.slice(start, end+1);
      try{ return JSON.parse(jsonText) }catch(e){
        // try to sanitize (remove trailing commas)
        const sane = jsonText.replace(/,\s*}/g,'}').replace(/,\s*]/g,']');
        try{ return JSON.parse(sane) }catch(e2){return null}
      }
    }

    function showResults(json){
      const protein = Number(json.protein_g || 0);
      const fat = Number(json.fat_g || 0);
      const carbs = Number(json.carbs_g || 0);
      const calories = Number(json.calories || Math.round((protein*4 + carbs*4 + fat*9)));
      const confidence = typeof json.confidence !== 'undefined' ? Number(json.confidence) : null;

      document.getElementById('protein').textContent = isFinite(protein)? protein.toFixed(1) : '—';
      document.getElementById('fat').textContent = isFinite(fat)? fat.toFixed(1) : '—';
      document.getElementById('carbs').textContent = isFinite(carbs)? carbs.toFixed(1) : '—';
      document.getElementById('calories').textContent = isFinite(calories)? Math.round(calories) + ' kcal' : '—';
      document.getElementById('confidence').textContent = (isFinite(confidence)? (confidence*100).toFixed(0)+'%' : '—');

      const calFromMacros = protein*4 + carbs*4 + fat*9;
      document.getElementById('macroCalories').textContent = isFinite(calFromMacros)? Math.round(calFromMacros)+' kcal (P:F:C = '+(protein*4).toFixed(0)+':'+(fat*9).toFixed(0)+':'+(carbs*4).toFixed(0)+')' : '—';

      const interpret = interpretMacros(protein,fat,carbs);
      document.getElementById('interpret').textContent = interpret;

      drawPie([protein, fat, carbs]);
    }

    function interpretMacros(p,f,c){
      const total = p+f+c;
      if(total===0) return 'No macro data.';
      const pPct = Math.round((p/total)*100);
      const fPct = Math.round((f/total)*100);
      const cPct = Math.round((c/total)*100);
      return `Protein ${pPct}%, Fat ${fPct}%, Carbs ${cPct}%`;
    }

    // simple pie chart
    function drawPie(vals){
      const canvas = document.getElementById('pie');
      const ctx = canvas.getContext('2d');
      ctx.clearRect(0,0,canvas.width,canvas.height);
      const total = vals.reduce((a,b)=>a+b,0);
      const cx = canvas.width/2 - 20;
      const cy = canvas.height/2;
      const radius = Math.min(canvas.width, canvas.height)/3;
      const colors = ['#7dd3fc','#fda4af','#fbbf24']; // protein, fat, carbs
      let start = -Math.PI/2;
      if(total===0){
        // draw empty ring
        ctx.beginPath();ctx.arc(cx,cy,radius,0,Math.PI*2);ctx.fillStyle='rgba(255,255,255,0.02)';ctx.fill();
        ctx.font='12px sans-serif';ctx.fillStyle='var(--muted)';ctx.fillText('No data',cx-18,cy+4);
        return;
      }
      for(let i=0;i<vals.length;i++){
        const slice = vals[i]/total;
        const end = start + slice*Math.PI*2;
        ctx.beginPath();ctx.moveTo(cx,cy);ctx.arc(cx,cy,radius,start,end);ctx.closePath();ctx.fillStyle=colors[i];ctx.fill();
        start=end;
      }
      // legend
      ctx.font='12px sans-serif';
      ctx.fillStyle='#e6eef8';
      const labels = ['Protein','Fat','Carbs'];
      for(let i=0;i<labels.length;i++){
        const x = canvas.width - 80;
        const y = 20 + i*20;
        ctx.fillStyle=colors[i];ctx.fillRect(x,y,12,12);
        ctx.fillStyle='#e6eef8';ctx.fillText(labels[i] + '  ' + (vals[i]? vals[i].toFixed(1)+' g':'—'), x+18, y+10);
      }
    }

    // initial
    resetResults();
  </script>
</body>
</html>
